name: Deploy to Walrus using Docker Hub Image

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]
  workflow_dispatch:
    inputs:
      network:
        description: 'Network to deploy to'
        required: true
        default: 'testnet'
        type: choice
        options:
        - testnet
        - mainnet
      epochs:
        description: 'Storage duration in epochs (testnet: 1 epoch = 2 days, mainnet: 1 epoch = 14 days)'
        required: true
        default: '1'
        type: string

env:
  NETWORK: ${{ github.event.inputs.network || 'testnet' }}
  EPOCHS: ${{ github.event.inputs.epochs || '1' }}
  DOCKER_IMAGE: deepsp94/walrus-deployment:latest

jobs:
  deploy:
    runs-on: ubuntu-latest
    
    outputs:
      site_url: ${{ steps.deploy.outputs.site_url }}
      deployment_id: ${{ steps.deploy.outputs.deployment_id }}
      epochs_used: ${{ steps.deploy.outputs.epochs_used }}
    
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
      
    - name: Set up Docker
      uses: docker/setup-buildx-action@v3
      
    - name: Pull Docker image from Docker Hub
      run: |
        echo "üê≥ Pulling Docker image: $DOCKER_IMAGE"
        docker pull $DOCKER_IMAGE
        echo "‚úÖ Docker image pulled successfully"
        
    - name: Install dependencies and build (if package.json exists)
      if: hashFiles('package.json') != ''
      run: |
        npm ci
        npm run build
    
    - name: Verify dist directory exists
      run: |
        if [ ! -d "./dist" ]; then
          echo "‚ùå Error: ./dist directory not found!"
          echo "Please ensure your build process creates a ./dist directory with static files."
          exit 1
        fi
        echo "‚úÖ Found ./dist directory with $(find ./dist -type f | wc -l) files"
        
    - name: Prepare environment file
      env:
        SUI_PRIVATE_KEY: ${{ secrets.SUI_PRIVATE_KEY }}
        SUI_ADDRESS: ${{ secrets.SUI_ADDRESS }}
      run: |
        # Validate required secrets
        if [ -z "$SUI_PRIVATE_KEY" ] || [ -z "$SUI_ADDRESS" ]; then
          echo "‚ùå Error: SUI_PRIVATE_KEY and SUI_ADDRESS secrets must be set in repository settings"
          echo "Please add these secrets to your GitHub repository:"
          echo "  - SUI_PRIVATE_KEY: Your Sui wallet private key (base64 encoded)"
          echo "  - SUI_ADDRESS: Your Sui wallet address"
          exit 1
        fi
        
        # Validate base64 encoding of private key
        if ! echo "$SUI_PRIVATE_KEY" | base64 -d > /dev/null 2>&1; then
          echo "‚ùå Error: SUI_PRIVATE_KEY is not properly base64 encoded"
          echo "Please ensure your private key is base64 encoded:"
          echo "  1. Export your private key: sui keytool export --key-identity <address> --json"
          echo "     This will give you a hex string (without 0x prefix)"
          echo "  2. Convert hex to base64: echo 'your_hex_private_key' | xxd -r -p | base64"
          echo "  3. Or if you have raw bytes: echo 'your_private_key_bytes' | base64"
          echo "  4. Update the SUI_PRIVATE_KEY secret with the base64 result"
          exit 1
        fi
        
        echo "‚úÖ Environment validation completed"
        
    - name: Deploy to Walrus using Docker
      id: deploy
      env:
        SUI_PRIVATE_KEY: ${{ secrets.SUI_PRIVATE_KEY }}
        SUI_ADDRESS: ${{ secrets.SUI_ADDRESS }}
      run: |
        echo "üöÄ Starting Walrus deployment using Docker container..."
        
        # Run Docker container with proper Sui wallet setup
        echo "üöÄ Running deployment container with Sui wallet setup..."
        docker run --rm \
          -v "$(pwd)/dist:/dist" \
          -v "$(pwd)/config/walrus-client.yaml:/root/.config/walrus/client_config.yaml" \
          -v "$(pwd)/config/walrus-site.yaml:/root/.config/walrus/site-config.yaml" \
          -e SUI_PRIVATE_KEY="$SUI_PRIVATE_KEY" \
          -e SUI_ADDRESS="$SUI_ADDRESS" \
          -e NETWORK="$NETWORK" \
          -e EPOCHS="$EPOCHS" \
          $DOCKER_IMAGE \
          /bin/bash -c "
            echo 'üîß Setting up Sui wallet inside container...'
            
            # Validate base64 encoding of private key
            if ! echo \"\$SUI_PRIVATE_KEY\" | base64 -d > /dev/null 2>&1; then
              echo '‚ùå Error: SUI_PRIVATE_KEY is not properly base64 encoded'
              exit 1
            fi
            
            # Create Sui client config directory
            mkdir -p ~/.sui/sui_config
            
            # Initialize Sui client configuration non-interactively
            echo 'üîß Initializing Sui client for '\$NETWORK' network...'
            echo 'keystore:' > ~/.sui/sui_config/client.yaml
            echo '  File: ~/.sui/sui_config/sui.keystore' >> ~/.sui/sui_config/client.yaml
            echo 'envs:' >> ~/.sui/sui_config/client.yaml
            echo '  - alias: '\$NETWORK >> ~/.sui/sui_config/client.yaml
            echo '    rpc: \"https://fullnode.'\$NETWORK'.sui.io:443\"' >> ~/.sui/sui_config/client.yaml
            echo '    ws: ~' >> ~/.sui/sui_config/client.yaml
            echo 'active_env: '\$NETWORK >> ~/.sui/sui_config/client.yaml
            echo 'active_address: \"'\$SUI_ADDRESS'\"' >> ~/.sui/sui_config/client.yaml
            
            # Convert base64 private key to suiprivkey format
            echo 'üîë Converting private key to Sui format...'
            SUIPRIVKEY=\$(sui keytool convert \"\$SUI_PRIVATE_KEY\")
            if [ -z \"\$SUIPRIVKEY\" ]; then
              echo '‚ùå Failed to convert private key to Sui format'
              exit 1
            fi
            
            # Import the converted private key using sui keytool
            echo 'üîë Importing private key into Sui keystore...'
            IMPORT_OUTPUT=\$(sui keytool import \"\$SUIPRIVKEY\" ed25519 --json)
            IMPORTED_ADDRESS=\$(echo \"\$IMPORT_OUTPUT\" | jq -r '.suiAddress' 2>/dev/null)
            
            # Verify the imported address matches the expected address
            if [ \"\$IMPORTED_ADDRESS\" != \"\$SUI_ADDRESS\" ]; then
              echo '‚ö†Ô∏è  Warning: Imported address ('\$IMPORTED_ADDRESS') differs from expected address ('\$SUI_ADDRESS')'
              echo 'This may indicate the wrong private key was provided.'
              echo 'Using imported address for deployment...'
              SUI_ADDRESS=\$IMPORTED_ADDRESS
              
              # Update the client config with the correct address
              sed -i \"s/active_address: .*/active_address: \\\"\$SUI_ADDRESS\\\"/\" ~/.sui/sui_config/client.yaml
            fi
            
            # Verify the address is now managed
            if ! sui client addresses | grep -q \"\$SUI_ADDRESS\"; then
              echo '‚ùå Address '\$SUI_ADDRESS' is not found in managed addresses after import'
              echo 'Managed addresses:'
              sui client addresses
              exit 1
            fi
            
            echo '‚úÖ Sui wallet configured with address: '\$SUI_ADDRESS
            
            # Check wallet setup
            echo 'üí∞ Checking Sui wallet setup...'
            sui client active-address || echo 'Warning: Could not verify active address'
            
            # Check wallet balance
            echo 'üí∞ Checking wallet balance...'
            BALANCE=\$(sui client gas --json 2>/dev/null | jq -r '.[0].balance // 0' 2>/dev/null || echo '0')
            echo \"Current SUI balance: \$BALANCE MIST\"
            
            if [ \"\$BALANCE\" = '0' ]; then
              echo '‚ö†Ô∏è  Warning: No SUI balance detected. Deployment may fail if gas is needed.'
            else
              echo '‚úÖ SUI balance available for gas fees'
            fi
            
            echo 'üöÄ Starting Walrus deployment...'
            /usr/local/bin/site-builder --config /root/.config/walrus/site-config.yaml --context \$NETWORK deploy /dist --epochs \$EPOCHS
          "
        
        echo "‚úÖ Deployment command completed"
        
    - name: Cleanup
      if: always()
      run: |
        echo "‚úÖ Cleanup completed"
        
    - name: Comment on PR (if applicable)
      if: github.event_name == 'pull_request' && steps.deploy.outputs.site_url
      uses: actions/github-script@v7
      with:
        script: |
          const siteUrl = '${{ steps.deploy.outputs.site_url }}';
          const network = '${{ env.NETWORK }}';
          const epochs = '${{ env.EPOCHS }}';
          
          github.rest.issues.createComment({
            issue_number: context.issue.number,
            owner: context.repo.owner,
            repo: context.repo.repo,
            body: `## üåê Walrus Preview Deployment (Docker Hub)
            
            Your site has been deployed to Walrus **${network}** using Docker image \`deepsp94/walrus-deployment:latest\`!
            
            **üîó Preview URL:** ${siteUrl}
            **‚è∞ Storage Duration:** ${epochs} epochs
            **üåê Network:** ${network}
            
            This deployment will be available for ${epochs} epochs (${network === 'mainnet' ? epochs * 14 : epochs * 2} days).`
          });
